<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SDQ – Questionário de Capacidades e Dificuldades</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--line:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--pri:#4f46e5;--ok:#22c55e;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:960px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.35rem}
  .muted{color:var(--muted)}
  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0 6px}
  @media(max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:#0b1220;border:1px solid var(--line);border-radius:10px;padding:10px}
  .info b{display:block;margin-bottom:4px;color:#cbd5e1}
  .q{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0b1220;margin-bottom:10px}
  .q h3{margin:0 0 8px;font-size:1rem}
  .opts{display:flex;flex-wrap:wrap;gap:10px}
  label.opt{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:10px;cursor:pointer}
  .opt input[type="radio"]{accent-color:var(--pri)}
  label.opt:has(input[type="radio"]:checked){ background:var(--pri); border-color:var(--pri); color:#fff; }
  label.opt:has(input[type="radio"]:checked) span{ color:#fff; font-weight:600; }
  label.opt:has(input[type="radio"]:focus-visible){ box-shadow:0 0 0 3px rgba(79,70,229,.35); border-color:var(--pri); }
  .btn{display:inline-flex;align-items:center;gap:8px;background:var(--pri);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin:10px 0;padding:10px;border-radius:8px}
  .okbox{background:#052e1a;border:1px solid #114d2a;color:#b3f7c1}
  .errbox{background:#3b0d0d;border:1px solid #5b1919;color:#ffd0d0}
  .warnbox{background:#3a2903;border:1px solid #5c4307;color:#ffe6b0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>SDQ – Questionário de Capacidades e Dificuldades</h1>
    <p class="muted">Respostas: <b>Falso</b> • <b>Mais ou menos verdadeiro</b> • <b>Verdadeiro.</b></p>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;">
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <div id="progress" class="muted"></div>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
// ======== CONFIG ========
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_SDQ" };
const CODE = "SDQ";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";

// ======== HELPERS ========
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const AUTOSAVE_KEY = `${CODE}_${qs("token")||"no_token"}`;

function setBox(id, text, kind="ok"){ const el=$(id); if(!el) return;
  el.textContent=text; el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox"); el.style.display="block";
}
function hideBox(id){ const el=$(id); if(el){ el.style.display="none"; el.textContent=""; } }
function maskCPF(cpf){ const d=onlyDigits(cpf||""); if(d.length!==11) return cpf||""; return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`; }
function fmtDateISO(iso){ if(!iso) return ""; const [y,m,d]=iso.split("-"); return (y&&m&&d)?`${d}/${m}/${y}`:iso; }
async function GET(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function POST(url, body){ const r=await fetch(url,{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function PATCH(url, body){ const r=await fetch(url,{method:"PATCH",headers:{ "Content-Type":"application/json" },body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function sheetSearch(sheet, params){ const usp=new URLSearchParams(params); return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`); }
async function sheetCreate(sheet, row){ return POST(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, { data:[row] }); }
async function sheetPatchBy(sheet, column, value, data){ return PATCH(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, { data }); }
function goPortalWithToken(){ const TOKEN=qs("token"); try{ const u=new URL(PORTAL_URL,location.href); u.searchParams.set("token",TOKEN); location.href=u.toString(); }catch(_){ const sep=PORTAL_URL.includes("?")?"&":"?"; location.href=PORTAL_URL+sep+"token="+encodeURIComponent(TOKEN); }}

// ======== ESCALA ========
const CHOICES = [
  {label:"Falso", value:0},
  {label:"Mais ou menos verdadeiro", value:1},
  {label:"Verdadeiro", value:2},
];

// ======== ITENS (1–25) ========
const ITEMS = [
  "Tem consideração pelos sentimentos de outras pessoas.",
  "Não consegue parar sentado quando tem que fazer a lição ou comer; mexe-se muito, esbarrando em coisas, derrubando coisas.",
  "Muitas vezes se queixa de dor de cabeça, dor de barriga ou enjoo.",
  "Tem boa vontade em compartilhar doces, brinquedos, lápis com outras crianças.",
  "Frequentemente tem acessos de raiva ou crises de birra.",
  "É solitário, prefere brincar sozinho.",
  "Geralmente é obediente e faz normalmente o que os adultos lhe pedem.",
  "Tem muitas preocupações, muitas vezes parece preocupado com tudo.",
  "Tenta ser atencioso se alguém parece magoado, aflito ou se sentindo mal.",
  "Está sempre agitado, balançando as pernas ou mexendo as mãos.",
  "Tem pelo menos um bom amigo ou amiga.",
  "Frequentemente briga com outras crianças ou as amedronta.",
  "Frequentemente parece triste, desanimado ou choroso.",
  "Em geral, é querido por outras crianças.",
  "Facilmente perde a concentração.",
  "Fica inseguro quando tem que fazer alguma coisa pela primeira vez, facilmente perde a confiança em si mesmo.",
  "É gentil com crianças mais novas.",
  "Frequentemente engana ou mente.",
  "Outras crianças ‘pegam no pé’ ou atormentam-no.",
  "Frequentemente se oferece para ajudar outras pessoas (pais, professores, outras crianças).",
  "Pensa nas coisas antes de fazê-las.",
  "Rouba coisas de casa, da escola ou de outros lugares.",
  "Se dá melhor com adultos do que com outras crianças.",
  "Tem muitos medos, assusta-se facilmente.",
  "Completa as tarefas que começa, tem boa concentração."
];

// ======== RENDER ========
const N = ITEMS.length;
function renderQuestions(){
  const host=$("#qs"); host.innerHTML="";
  ITEMS.forEach((text, idx)=>{
    const n=idx+1, qn=String(n).padStart(2,"0");
    const wrap=document.createElement("div");
    wrap.className="q"; wrap.setAttribute("role","group"); wrap.setAttribute("aria-labelledby",`lbl${qn}`);
    wrap.innerHTML = `<h3 id="lbl${qn}">${n}. ${text}</h3>`;
    const opts=document.createElement("div"); opts.className="opts";
    CHOICES.forEach((c,i)=>{
      const id=`q${qn}_${i}`;
      const lab=document.createElement("label"); lab.className="opt";
      lab.innerHTML=`<input type="radio" name="q${qn}" id="${id}" value="${c.value}" required><span>${c.label}</span>`;
      opts.appendChild(lab);
    });
    wrap.appendChild(opts); host.appendChild(wrap);
  });

  const updateProg=()=>{
    const answered=document.querySelectorAll('#qs input[type="radio"]:checked').length;
    $("#progress").textContent=`${answered}/${N} respondidas`;
  };
  host.addEventListener("change", ()=>{ updateProg(); autosaveAnswers(); });
  updateProg();
}

// ======== AUTOSAVE ========
function autosaveAnswers(){
  const answers={};
  for(let i=1;i<=N;i++){
    const qn=`q${String(i).padStart(2,"0")}`;
    const sel=document.querySelector(`input[name="${qn}"]:checked`);
    if(sel) answers[i]=Number(sel.value);
  }
  localStorage.setItem(AUTOSAVE_KEY, JSON.stringify({ code: CODE, token: qs("token"), answers }));
}
function restoreAutosave(){
  try{
    const raw=localStorage.getItem(AUTOSAVE_KEY); if(!raw) return;
    const {answers}=JSON.parse(raw)||{}; if(!answers) return;
    Object.entries(answers).forEach(([i,val])=>{
      const qn=String(i).padStart(2,"0");
      const el=document.querySelector(`input[name="q${qn}"][value="${val}"]`);
      if(el) el.checked=true;
    });
    const answered=Object.keys(answers).length;
    $("#progress").textContent=`${answered}/${N} respondidas`;
  }catch(_){}
}
function clearAutosave(){ localStorage.removeItem(AUTOSAVE_KEY); }

// ======== ESTADO ========
let patient=null, tokenRow=null, CPF="";
let startAt = Date.now();

// ======== BOOT POR TOKEN ========
(async function boot(){
  try{
    const TOKEN=qs("token");
    if(!TOKEN){ setBox("#alert","Link inválido (sem token). Solicite um novo link.","err"); return; }

    const trows=await sheetSearch(SHEETS.TOKENS,{ token:TOKEN });
    if(!trows?.length) throw new Error("Token inválido ou expirado.");
    tokenRow=trows[0];
    const disabled=String(tokenRow.disabled||"não").toLowerCase()==="sim";
    const expired = tokenRow.expires_at && (Date.parse(tokenRow.expires_at) < Date.now());
    if(disabled || expired) throw new Error("Token desativado/expirado. Peça um novo link.");

    CPF=onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows=await sheetSearch(SHEETS.PATIENTS,{ cpf:CPF });
    if(!prows?.length) throw new Error("Paciente não encontrado.");
    patient=prows[0];

    const allowed=String(patient[CODE]||"").toLowerCase()==="sim";
    if(!allowed){ setBox("#alert","Este formulário não está liberado para você. Entre em contato com o consultório.","err"); return; }

    const flagDone=String(patient[`${CODE}_FEITO`]||"").toLowerCase()==="sim";
    const already=await sheetSearch(SHEETS.SCORES,{ cpf:CPF, code:CODE });
    if(flagDone || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200); return;
    }

    renderPatientInfo();
    renderQuestions();
    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    hideBox("#alert");
    startAt=Date.now();
    restoreAutosave();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  const info=[["Nome",patient.nome||"-"],["CPF",maskCPF(patient.cpf)],["Nascimento",fmtDateISO(patient.data_nascimento)],["E-mail",patient.email||"-"],["WhatsApp",patient.whatsapp||"-"]];
  for(const [k,v] of info){
    const d=document.createElement("div"); d.className="info";
    d.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(d);
  }
}

// ======== SUBMIT ========
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return; sending=true; hideBox("#msg");
  const btn=$("#btnSubmit"); const originalText=btn.textContent; btn.disabled=true; btn.textContent="Enviando…";

  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // coleta
    const answers={}; let firstMissing=null;
    for(let i=1;i<=N;i++){
      const qn=`q${String(i).padStart(2,"0")}`;
      const sel=document.querySelector(`input[name="${qn}"]:checked`);
      if(!sel && firstMissing===null) firstMissing=i;
      if(sel) answers[i]=Number(sel.value);
    }
    if(firstMissing){
      setBox("#msg", `Responda o item ${firstMissing}.`, "warn");
      document.getElementById(`lbl${String(firstMissing).padStart(2,"0")}`)?.scrollIntoView({behavior:"smooth",block:"center"});
      sending=false; btn.disabled=false; btn.textContent=originalText; return;
    }

    // anti-duplicidade
    const again=await sheetSearch(SHEETS.SCORES,{ cpf:onlyDigits(patient.cpf), code:CODE });
    if(again && again.length){
      setBox("#msg","Este formulário já foi enviado anteriormente. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken, 1000); return;
    }

    // soma total
    const total = Object.values(answers).reduce((s,v)=>s+v,0);

    const row = {
      result_id:`${patient.cpf}_${CODE}_${Date.now()}`,
      token:qs("token"),
      cpf:patient.cpf,
      code:CODE,
      source:"paciente",
      submitted_at:new Date().toISOString(),
      total,                // também em 'total'
      categoria: String(total), // <-- soma total gravada na coluna categoria (como pediu)
      metrics: JSON.stringify({ answers })
    };
    await sheetCreate(SHEETS.SCORES,row);

    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,{ [`${CODE}_FEITO`]:"sim", [`${CODE}_FEITO_AT`]: new Date().toISOString() });

    clearAutosave();
    setBox("#msg","Formulário enviado. Retornando ao portal…","ok");
    setTimeout(goPortalWithToken, 1200);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false; btn.disabled=false; btn.textContent=originalText;
  }
});
</script>
</body>
</html>
